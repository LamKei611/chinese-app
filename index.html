<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Learning Notebook</title>
    
    <!-- App Icon for iOS -->
    <link rel="apple-touch-icon" href="app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chinese Notes">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8d5ba 0%, #7cb89d 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        h1 {
            font-family: 'Cherry Bomb One', cursive;
            font-weight: 400;
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        body.grammar-active {
            background: linear-gradient(135deg, #f5a9c1 0%, #e88ca7 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .tab-button {
            padding: 12px 30px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-color: white;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44,62,80,0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(44,62,80,0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44,62,80,0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 8px 16px;
            background: rgba(44,62,80,0.1);
            color: #2c3e50;
            border: 2px solid #2c3e50;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .sort-btn:hover {
            background: #2c3e50;
            color: white;
        }

        .sort-btn.active {
            background: #2c3e50;
            color: white;
        }

        .item-list {
            display: grid;
            gap: 15px;
        }

        .vocab-item, .grammar-item {
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .vocab-item:hover, .grammar-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .vocab-item {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            display: flex;
            gap: 14px;
            align-items: flex-start;
            cursor: pointer;
        }

        .vocab-item:hover {
            filter: brightness(0.97);
        }

        .hanzi {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: bold;
            min-width: 52px;
            text-align: center;
            padding-top: 2px;
        }

        .vocab-main {
            flex: 1;
        }

        .vocab-line1 {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .pinyin {
            font-size: 1em;
            color: #3d6b52;
            font-weight: 600;
        }

        .word-type {
            background: rgba(44, 62, 80, 0.12);
            color: #2c3e50;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.78em;
            font-weight: 600;
        }

        .han-viet {
            font-size: 0.88em;
            color: #5a7a65;
            font-style: italic;
        }

        .vocab-meaning {
            font-size: 0.95em;
            color: #2c3e50;
            line-height: 1.5;
        }

        .vocab-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .vocab-content.expanded {
            max-height: 300px;
        }

        .vocab-summary {
            font-size: 0.95em;
            color: #2c3e50;
            line-height: 1.5;
        }

        .expand-hint {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .vocab-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .vocab-content-old {
            max-height: 60px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .vocab-content-old.expanded {
            max-height: 500px;
        }

        .pinyin {
            color: #34495e;
            font-weight: 600;
            font-size: 1.1em;
        }

        .han-viet {
            color: #555;
            font-style: italic;
        }

        .meaning {
            color: #333;
            font-weight: 500;
            margin-top: 5px;
        }

        .word-type {
            display: inline-block;
            padding: 4px 12px;
            background: #2c3e50;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .grammar-item {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); /* Pastel pink */
            border-left: 4px solid #2c3e50;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            cursor: pointer;
        }

        .grammar-item:hover {
            filter: brightness(0.97);
        }

        .grammar-summary {
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
            margin-bottom: 2px;
        }

        .grammar-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .grammar-notes {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .grammar-example {
            background: rgba(255,255,255,0.6);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-style: italic;
        }

        .grammar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .grammar-content.expanded {
            max-height: 1000px;
        }

        .show-more-btn {
            background: transparent;
            color: #2c3e50;
            border: 1px solid #2c3e50;
            padding: 6px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            margin-top: 10px;
            display: inline-block;
        }

        .show-more-btn:hover {
            background: #2c3e50;
            color: white;
        }

        .delete-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .edit-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .print-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .print-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .btn-icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .print-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .select-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .google-sheets-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .google-sheets-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .sync-status {
            font-size: 0.85em;
            color: #666;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .vocab-item { flex-wrap: wrap; }
            .hanzi { font-size: 1.5em; min-width: 42px; }
            .form-row { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: row; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chinese Learning Notebook</h1>
        <p class="subtitle">Your friendly companion for vocabulary and grammar</p>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('vocab', this)">Vocabulary</button>
            <button class="tab-button" onclick="switchTab('grammar', this)">Grammar</button>
            <button class="google-sheets-btn" onclick="setupGoogleSheets()" style="margin-left: 20px;">Setup Sheets</button>
            <button class="google-sheets-btn" onclick="syncFromGoogleSheets()">Import from Sheets</button>
        </div>

        <!-- Vocabulary Section -->
        <div id="vocab" class="section active">
            <div class="card">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Word</h2>
                <form id="vocabForm" onsubmit="addVocab(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hanzi (汉字)</label>
                            <input type="text" id="hanzi" required placeholder="例如: 你好">
                        </div>
                        <div class="form-group">
                            <label>Pinyin</label>
                            <input type="text" id="pinyin" required placeholder="nǐ hǎo">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hán Việt</label>
                            <input type="text" id="hanViet" placeholder="nhĩ hảo">
                        </div>
                        <div class="form-group">
                            <label>Type of Word</label>
                            <input type="text" id="wordType" list="wordTypeOptions" required placeholder="Select or type your own...">
                            <datalist id="wordTypeOptions">
                                <option value="Noun (Danh từ)">
                                <option value="Verb (Động từ)">
                                <option value="Adjective (Tính từ)">
                                <option value="Adverb (Trạng từ)">
                                <option value="Phrase (Cụm từ)">
                                <option value="Other (Khác)">
                            </datalist>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Vietnamese Meaning</label>
                        <textarea id="meaning" required placeholder="Xin chào" rows="3"></textarea>
                    </div>
                    <button type="submit">Add Word</button>
                </form>
            </div>

            <div class="card">
                <div class="controls">
                    <h2 style="color: #2c3e50;">My Vocabulary</h2>
                    <div class="sort-buttons">
                        <button class="sort-btn" onclick="sortVocab('date')">By Date</button>
                        <button class="sort-btn" onclick="sortVocab('hanzi')">By Hanzi</button>
                        <button class="sort-btn" onclick="sortVocab('type')">By Type</button>
                        <button class="print-btn" onclick="printVocabPDF()" title="Print Selected">
                            <svg class="print-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div class="selection-controls">
                    <input type="text" id="vocabSearch" placeholder="Search vocabulary..." onkeyup="searchVocab()" style="flex: 1; max-width: 300px;">
                    <button class="select-btn" onclick="toggleSelectAllVocab()">Select All</button>
                    <button class="select-btn" onclick="deselectAllVocab()">Deselect All</button>
                    <span id="vocabSelectedCount" class="sync-status"></span>
                </div>
                <div id="vocabList" class="item-list"></div>
            </div>
        </div>

        <!-- Grammar Section -->
        <div id="grammar" class="section">
            <div class="card">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Grammar</h2>
                <form id="grammarForm" onsubmit="addGrammar(event)">
                    <div class="form-group">
                        <label>Grammar Pattern</label>
                        <input type="text" id="grammarPattern" required placeholder="例如: 不是...而是...">
                    </div>
                    <div class="form-group">
                        <label>Examples</label>
                        <textarea id="grammarExamples" required placeholder="他不是老师，而是学生。&#10;Anh ấy không phải là giáo viên mà là học sinh."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="grammarNotes" placeholder="Usage notes, tips, and explanations..."></textarea>
                    </div>
                    <button type="submit">Add Grammar</button>
                </form>
            </div>

            <div class="card">
                <div class="controls">
                    <h2 style="color: #2c3e50;">My Grammar Notes</h2>
                    <div class="sort-buttons">
                        <button class="sort-btn" onclick="sortGrammar('date')">By Date</button>
                        <button class="sort-btn" onclick="sortGrammar('pattern')">By Pattern</button>
                        <button class="print-btn" onclick="printGrammarPDF()" title="Print Selected">
                            <svg class="print-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div class="selection-controls">
                    <input type="text" id="grammarSearch" placeholder="Search grammar..." onkeyup="searchGrammar()" style="flex: 1; max-width: 300px;">
                    <button class="select-btn" onclick="toggleSelectAllGrammar()">Select All</button>
                    <button class="select-btn" onclick="deselectAllGrammar()">Deselect All</button>
                    <span id="grammarSelectedCount" class="sync-status"></span>
                </div>
                <div id="grammarList" class="item-list"></div>
            </div>
        </div>

    </div>

    <script>
        // Initialize data from localStorage
        let vocabData = JSON.parse(localStorage.getItem('vocabData')) || [];
        let grammarData = JSON.parse(localStorage.getItem('grammarData')) || [];
        let editingVocabId = null;
        let editingGrammarId = null;
        let googleSheetsUrl = localStorage.getItem('googleSheetsUrl') || null;
        let googleSheetId = localStorage.getItem('googleSheetId') || null;

        // Switch between tabs
        function switchTab(tab, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (btn) btn.classList.add('active');
            document.body.classList.remove('grammar-active');
            if (tab === 'grammar') document.body.classList.add('grammar-active');
        }

        // Add or edit vocabulary
        function addVocab(event) {
            event.preventDefault();
            
            const vocab = {
                id: editingVocabId || Date.now(),
                hanzi: document.getElementById('hanzi').value,
                pinyin: document.getElementById('pinyin').value,
                hanViet: document.getElementById('hanViet').value,
                wordType: document.getElementById('wordType').value,
                meaning: document.getElementById('meaning').value,
                date: editingVocabId ? vocabData.find(v => v.id === editingVocabId).date : new Date().toISOString()
            };

            if (editingVocabId) {
                const index = vocabData.findIndex(v => v.id === editingVocabId);
                vocabData[index] = vocab;
                editingVocabId = null;
                document.querySelector('#vocabForm button[type="submit"]').textContent = 'Add Word';
            } else {
                vocabData.push(vocab);
            }

            localStorage.setItem('vocabData', JSON.stringify(vocabData));
            
            document.getElementById('vocabForm').reset();
            renderVocab();
            
            // Auto-sync to Google Sheets
            if (googleSheetsUrl) {
                syncToGoogleSheets();
            }
        }

        // Add or edit grammar
        function addGrammar(event) {
            event.preventDefault();
            
            const grammar = {
                id: editingGrammarId || Date.now(),
                pattern: document.getElementById('grammarPattern').value,
                examples: document.getElementById('grammarExamples').value,
                notes: document.getElementById('grammarNotes').value,
                date: editingGrammarId ? grammarData.find(g => g.id === editingGrammarId).date : new Date().toISOString()
            };

            if (editingGrammarId) {
                const index = grammarData.findIndex(g => g.id === editingGrammarId);
                grammarData[index] = grammar;
                editingGrammarId = null;
                document.querySelector('#grammarForm button[type="submit"]').textContent = 'Add Grammar';
            } else {
                grammarData.push(grammar);
            }

            localStorage.setItem('grammarData', JSON.stringify(grammarData));
            
            document.getElementById('grammarForm').reset();
            renderGrammar();
            
            // Auto-sync to Google Sheets
            if (googleSheetsUrl) {
                syncToGoogleSheets();
            }
        }

        // Sort vocabulary
        function sortVocab(by) {
            document.querySelectorAll('#vocab .sort-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (by === 'date') {
                vocabData.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (by === 'hanzi') {
                vocabData.sort((a, b) => a.hanzi.localeCompare(b.hanzi));
            } else if (by === 'type') {
                vocabData.sort((a, b) => a.wordType.localeCompare(b.wordType));
            }
            
            renderVocab();
        }

        // Sort grammar
        function sortGrammar(by) {
            document.querySelectorAll('#grammar .sort-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (by === 'date') {
                grammarData.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (by === 'pattern') {
                grammarData.sort((a, b) => a.pattern.localeCompare(b.pattern));
            }
            
            renderGrammar();
        }

        // Edit vocabulary
        function editVocab(id) {
            const vocab = vocabData.find(v => v.id === id);
            if (!vocab) return;

            document.getElementById('hanzi').value = vocab.hanzi;
            document.getElementById('pinyin').value = vocab.pinyin;
            document.getElementById('hanViet').value = vocab.hanViet;
            document.getElementById('wordType').value = vocab.wordType;
            document.getElementById('meaning').value = vocab.meaning;

            editingVocabId = id;
            document.querySelector('#vocabForm button[type="submit"]').textContent = 'Update Word';
            
            // Scroll to form
            document.getElementById('vocabForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Edit grammar
        function editGrammar(id) {
            const grammar = grammarData.find(g => g.id === id);
            if (!grammar) return;

            document.getElementById('grammarPattern').value = grammar.pattern;
            document.getElementById('grammarExamples').value = grammar.examples;
            document.getElementById('grammarNotes').value = grammar.notes;

            editingGrammarId = id;
            document.querySelector('#grammarForm button[type="submit"]').textContent = 'Update Grammar';
            
            // Scroll to form
            document.getElementById('grammarForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Delete vocabulary
        function deleteVocab(id) {
            if (confirm('Are you sure you want to delete this word?')) {
                vocabData = vocabData.filter(v => v.id !== id);
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                renderVocab();
                
                // Sync to Google Sheets
                if (googleSheetsUrl) {
                    syncToGoogleSheets();
                }
            }
        }

        // Delete grammar
        function deleteGrammar(id) {
            if (confirm('Are you sure you want to delete this grammar note?')) {
                grammarData = grammarData.filter(g => g.id !== id);
                localStorage.setItem('grammarData', JSON.stringify(grammarData));
                renderGrammar();
                
                // Sync to Google Sheets
                if (googleSheetsUrl) {
                    syncToGoogleSheets();
                }
            }
        }

        // Render vocabulary list
        function renderVocab() {
            const list = document.getElementById('vocabList');
            
            if (vocabData.length === 0) {
                list.innerHTML = '<div class="empty-state">No vocabulary yet. Add your first word!</div>';
                document.getElementById('vocabSelectedCount').textContent = '';
                return;
            }

            list.innerHTML = vocabData.map(v => {
                const isLong = v.meaning.length > 60;
                const preview = isLong ? v.meaning.substring(0, 60) + '…' : v.meaning;
                return `
                <div class="vocab-item" onclick="toggleVocabContent(${v.id}, event)">
                    <input type="checkbox" class="item-checkbox vocab-checkbox" data-id="${v.id}" onchange="updateVocabCount()" onclick="event.stopPropagation()">
                    <div class="hanzi">${v.hanzi}</div>
                    <div class="vocab-main">
                        <div class="vocab-line1">
                            <span class="pinyin">${v.pinyin}</span>
                            <span class="word-type">${v.wordType}</span>
                            ${v.hanViet ? `<span class="han-viet">${v.hanViet}</span>` : ''}
                        </div>
                        <div class="vocab-summary" id="vocab-summary-${v.id}">${preview}</div>
                        <div class="vocab-content" id="vocab-content-${v.id}">
                            ${isLong ? `<div style="margin-top:4px; font-size:0.93em; color:#2c3e50; line-height:1.6;">${v.meaning}</div>` : ''}
                        </div>
                        ${isLong ? `<div class="expand-hint" id="vocab-hint-${v.id}">▼ tap to expand</div>` : ''}
                    </div>
                    <div class="action-buttons" onclick="event.stopPropagation()">
                        <button class="edit-btn" onclick="editVocab(${v.id})" title="Edit">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-btn" onclick="deleteVocab(${v.id})" title="Delete">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
            updateVocabCount();
        }

        // Render grammar list
        function renderGrammar() {
            const list = document.getElementById('grammarList');
            
            if (grammarData.length === 0) {
                list.innerHTML = '<div class="empty-state">No grammar notes yet. Add your first pattern!</div>';
                document.getElementById('grammarSelectedCount').textContent = '';
                return;
            }

            list.innerHTML = grammarData.map(g => {
                const notesPreview = g.notes ? (g.notes.length > 70 ? g.notes.substring(0,70) + '…' : g.notes) : '';
                const exPreview = g.examples ? (g.examples.length > 70 ? g.examples.substring(0,70) + '…' : g.examples) : '';
                const preview = notesPreview || exPreview;
                return `
                <div class="grammar-item" onclick="toggleGrammarContent(${g.id})">
                    <input type="checkbox" class="item-checkbox grammar-checkbox" data-id="${g.id}" onchange="updateGrammarCount()" onclick="event.stopPropagation()">
                    <div style="flex: 1;">
                        <div class="grammar-title">${g.pattern}</div>
                        <div class="grammar-summary" id="grammar-summary-${g.id}">${preview}</div>
                        <div class="grammar-content" id="grammar-content-${g.id}">
                            ${g.notes ? `<div class="grammar-notes"><strong>Notes:</strong> ${g.notes}</div>` : ''}
                            <div class="grammar-example"><strong>Examples:</strong><br>${g.examples.replace(/\n/g, '<br>')}</div>
                        </div>
                        <div class="expand-hint" id="grammar-hint-${g.id}">▼ tap to expand</div>
                    </div>
                    <div class="action-buttons" style="margin-top: 10px;" onclick="event.stopPropagation()">
                        <button class="edit-btn" onclick="editGrammar(${g.id})" title="Edit">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-btn" onclick="deleteGrammar(${g.id})" title="Delete">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
            updateGrammarCount();
        }

        // Initial render
        renderVocab();
        renderGrammar();
        
        // Auto-sync from Google Sheets on load (for cross-device sync)
        if (googleSheetsUrl) {
            syncFromGoogleSheetsSilent();
        }

        // Selection functions
        function toggleSelectAllVocab() {
            const checkboxes = document.querySelectorAll('.vocab-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateVocabCount();
        }

        function deselectAllVocab() {
            document.querySelectorAll('.vocab-checkbox').forEach(cb => cb.checked = false);
            updateVocabCount();
        }

        function toggleSelectAllGrammar() {
            const checkboxes = document.querySelectorAll('.grammar-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateGrammarCount();
        }

        function deselectAllGrammar() {
            document.querySelectorAll('.grammar-checkbox').forEach(cb => cb.checked = false);
            updateGrammarCount();
        }

        function updateVocabCount() {
            const selected = document.querySelectorAll('.vocab-checkbox:checked').length;
            const total = vocabData.length;
            document.getElementById('vocabSelectedCount').textContent = 
                selected > 0 ? `${selected} of ${total} selected` : '';
        }

        function updateGrammarCount() {
            const selected = document.querySelectorAll('.grammar-checkbox:checked').length;
            const total = grammarData.length;
            document.getElementById('grammarSelectedCount').textContent = 
                selected > 0 ? `${selected} of ${total} selected` : '';
        }

        // Search functions
        function searchVocab() {
            const searchTerm = document.getElementById('vocabSearch').value.toLowerCase();
            const items = document.querySelectorAll('.vocab-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'grid';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function searchGrammar() {
            const searchTerm = document.getElementById('grammarSearch').value.toLowerCase();
            const items = document.querySelectorAll('.grammar-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Toggle vocabulary content expansion (click-on-card)
        function toggleVocabContent(id, event) {
            const content = document.getElementById(`vocab-content-${id}`);
            const summary = document.getElementById(`vocab-summary-${id}`);
            const hint = document.getElementById(`vocab-hint-${id}`);
            if (!content) return;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (summary) summary.style.display = '';
                if (hint) hint.textContent = '▼ tap to expand';
            } else {
                content.classList.add('expanded');
                if (summary) summary.style.display = 'none';
                if (hint) hint.textContent = '▲ tap to collapse';
            }
        }

        // Toggle grammar content expansion (click-on-card)
        function toggleGrammarContent(id) {
            const content = document.getElementById(`grammar-content-${id}`);
            const summary = document.getElementById(`grammar-summary-${id}`);
            const hint = document.getElementById(`grammar-hint-${id}`);
            if (!content) return;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (summary) summary.style.display = '';
                if (hint) hint.textContent = '▼ tap to expand';
            } else {
                content.classList.add('expanded');
                if (summary) summary.style.display = 'none';
                if (hint) hint.textContent = '▲ tap to collapse';
            }
        }

        // Print Vocabulary (only selected)
        async function printVocabPDF() {
            // First, try to sync from Google Sheets to get latest data
            if (googleSheetsUrl) {
                await syncFromGoogleSheetsSilent();
            }
            
            const selectedCheckboxes = document.querySelectorAll('.vocab-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one word to print!');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            const selectedVocab = vocabData.filter(v => selectedIds.includes(v.id));

            // Create a printable HTML page
            const printWindow = window.open('', '', 'width=800,height=600');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>My Chinese Vocabulary</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                        }
                        .date {
                            color: #666;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        td {
                            border: 1px solid #ddd;
                            padding: 10px;
                        }
                        tr:nth-child(even) {
                            background-color: #f5f7fa;
                        }
                        .hanzi {
                            font-size: 20px;
                            font-weight: bold;
                            text-align: center;
                        }
                        .type {
                            text-align: center;
                            font-size: 13px;
                        }
                        .footer {
                            color: #666;
                            font-size: 14px;
                            margin-top: 20px;
                        }
                        @media print {
                            body {
                                padding: 10px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>My Chinese Vocabulary</h1>
                    <div class="date">Generated: ${new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%;">Hanzi</th>
                                <th style="width: 20%;">Pinyin</th>
                                <th style="width: 20%;">Hán Việt</th>
                                <th style="width: 30%;">Meaning</th>
                                <th style="width: 15%;">Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedVocab.map(v => `
                                <tr>
                                    <td class="hanzi">${v.hanzi}</td>
                                    <td>${v.pinyin}</td>
                                    <td>${v.hanViet || '-'}</td>
                                    <td>${v.meaning}</td>
                                    <td class="type">${v.wordType}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">Total words: ${selectedVocab.length}</div>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Print Grammar (only selected)
        async function printGrammarPDF() {
            // First, try to sync from Google Sheets to get latest data
            if (googleSheetsUrl) {
                await syncFromGoogleSheetsSilent();
            }
            
            const selectedCheckboxes = document.querySelectorAll('.grammar-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one grammar pattern to print!');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            const selectedGrammar = grammarData.filter(g => selectedIds.includes(g.id));

            // Create a printable HTML page
            const printWindow = window.open('', '', 'width=800,height=600');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>My Chinese Grammar Notes</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                        }
                        .date {
                            color: #666;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            vertical-align: top;
                        }
                        tr:nth-child(even) {
                            background-color: #f5f7fa;
                        }
                        .pattern {
                            font-size: 16px;
                            font-weight: bold;
                        }
                        .examples {
                            white-space: pre-line;
                            line-height: 1.6;
                        }
                        .footer {
                            color: #666;
                            font-size: 14px;
                            margin-top: 20px;
                        }
                        @media print {
                            body {
                                padding: 10px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>My Chinese Grammar Notes</h1>
                    <div class="date">Generated: ${new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 25%;">Grammar Pattern</th>
                                <th style="width: 45%;">Examples</th>
                                <th style="width: 30%;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedGrammar.map(g => `
                                <tr>
                                    <td class="pattern">${g.pattern}</td>
                                    <td class="examples">${g.examples}</td>
                                    <td>${g.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">Total grammar patterns: ${selectedGrammar.length}</div>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Google Sheets Integration
        function setupGoogleSheets() {
            const instructions = `
To sync with Google Sheets (TWO-WAY SYNC):

1. Create a new Google Sheet
2. Go to Extensions → Apps Script
3. Delete any code and paste the NEW code (see next step)
4. Deploy as Web App
5. Copy BOTH the Web App URL AND your Google Sheet URL

The app will show you the code to paste in the next step.

Ready to continue?`;

            if (!confirm(instructions)) return;

            const code = `function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var data = JSON.parse(e.postData.contents);
  
  if (data.type === 'vocab') {
    var vocabSheet = sheet.getSheetByName('Vocabulary') || sheet.insertSheet('Vocabulary');
    vocabSheet.clear();
    vocabSheet.appendRow(['Hanzi', 'Pinyin', 'Hán Việt', 'Meaning', 'Type', 'Date']);
    data.items.forEach(item => {
      vocabSheet.appendRow([item.hanzi, item.pinyin, item.hanViet, item.meaning, item.wordType, item.date]);
    });
  } else if (data.type === 'grammar') {
    var grammarSheet = sheet.getSheetByName('Grammar') || sheet.insertSheet('Grammar');
    grammarSheet.clear();
    grammarSheet.appendRow(['Pattern', 'Examples', 'Notes', 'Date']);
    data.items.forEach(item => {
      grammarSheet.appendRow([item.pattern, item.examples, item.notes, item.date]);
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var result = {};
  
  // Get vocabulary
  var vocabSheet = sheet.getSheetByName('Vocabulary');
  if (vocabSheet) {
    var vocabData = vocabSheet.getDataRange().getValues();
    result.vocab = vocabData.slice(1).map(row => ({
      hanzi: row[0],
      pinyin: row[1],
      hanViet: row[2],
      meaning: row[3],
      wordType: row[4],
      date: row[5]
    }));
  }
  
  // Get grammar
  var grammarSheet = sheet.getSheetByName('Grammar');
  if (grammarSheet) {
    var grammarData = grammarSheet.getDataRange().getValues();
    result.grammar = grammarData.slice(1).map(row => ({
      pattern: row[0],
      examples: row[1],
      notes: row[2],
      date: row[3]
    }));
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}`;

            alert('Copy this code to paste into Apps Script:\n\n' + code);

            const url = prompt('Step 1: Paste your Web App URL here:');
            if (!url) return;

            const sheetUrl = prompt('Step 2: Paste your Google Sheet URL here (e.g., https://docs.google.com/spreadsheets/d/ABC123...)');
            if (!sheetUrl) return;

            // Extract sheet ID from URL
            const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                googleSheetId = match[1];
                googleSheetsUrl = url;
                localStorage.setItem('googleSheetsUrl', url);
                localStorage.setItem('googleSheetId', googleSheetId);
                alert('Google Sheets connected! You can now sync both ways:\n• App → Sheets (automatic)\n• Sheets → App (click "Import from Sheets")');
                syncToGoogleSheets();
            } else {
                alert('Invalid Google Sheet URL. Please try again.');
            }
        }

        async function syncToGoogleSheets() {
            if (!googleSheetsUrl) return;

            try {
                // Sync vocabulary
                await fetch(googleSheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'vocab',
                        items: vocabData
                    })
                });

                // Sync grammar
                await fetch(googleSheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'grammar',
                        items: grammarData
                    })
                });

                console.log('Synced to Google Sheets');
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        // Import data FROM Google Sheets
        async function syncFromGoogleSheets() {
            if (!googleSheetsUrl) {
                alert('Please setup Google Sheets connection first!');
                return;
            }

            if (!confirm('This will import data from Google Sheets and merge with your current data. Continue?')) {
                return;
            }

            try {
                const response = await fetch(googleSheetsUrl);
                const data = await response.json();

                let importedVocab = 0;
                let importedGrammar = 0;

                // Import vocabulary
                if (data.vocab && data.vocab.length > 0) {
                    data.vocab.forEach(item => {
                        // Check if item already exists by matching hanzi and pinyin
                        const existingIndex = vocabData.findIndex(v => 
                            v.hanzi === item.hanzi && v.pinyin === item.pinyin
                        );
                        
                        if (existingIndex === -1) {
                            // Add new item with unique ID
                            vocabData.push({
                                id: Date.now() + Math.random(),
                                hanzi: item.hanzi,
                                pinyin: item.pinyin,
                                hanViet: item.hanViet || '',
                                meaning: item.meaning,
                                wordType: item.wordType,
                                date: item.date || new Date().toISOString()
                            });
                            importedVocab++;
                        } else {
                            // Update existing item
                            vocabData[existingIndex] = {
                                ...vocabData[existingIndex],
                                hanViet: item.hanViet || vocabData[existingIndex].hanViet,
                                meaning: item.meaning,
                                wordType: item.wordType
                            };
                        }
                    });
                }

                // Import grammar
                if (data.grammar && data.grammar.length > 0) {
                    data.grammar.forEach(item => {
                        // Check if item already exists by pattern
                        const existingIndex = grammarData.findIndex(g => 
                            g.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            // Add new item with unique ID
                            grammarData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                            importedGrammar++;
                        } else {
                            // Update existing item
                            grammarData[existingIndex] = {
                                ...grammarData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || grammarData[existingIndex].notes
                            };
                        }
                    });
                }

                // Save to localStorage
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                localStorage.setItem('grammarData', JSON.stringify(grammarData));

                // Re-render
                renderVocab();
                renderGrammar();

                alert(`Successfully imported!\nNew vocabulary: ${importedVocab}\nNew grammar: ${importedGrammar}`);
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing from Google Sheets. Make sure:\n1. You deployed the script with doGet() function\n2. Access is set to "Anyone"\n3. The URL is correct');
            }
        }

        // Silent sync (no alerts) for use before printing
        async function syncFromGoogleSheetsSilent() {
            if (!googleSheetsUrl) return;

            try {
                const response = await fetch(googleSheetsUrl);
                const data = await response.json();

                // Import vocabulary
                if (data.vocab && data.vocab.length > 0) {
                    data.vocab.forEach(item => {
                        const existingIndex = vocabData.findIndex(v => 
                            v.hanzi === item.hanzi && v.pinyin === item.pinyin
                        );
                        
                        if (existingIndex === -1) {
                            vocabData.push({
                                id: Date.now() + Math.random(),
                                hanzi: item.hanzi,
                                pinyin: item.pinyin,
                                hanViet: item.hanViet || '',
                                meaning: item.meaning,
                                wordType: item.wordType,
                                date: item.date || new Date().toISOString()
                            });
                        } else {
                            vocabData[existingIndex] = {
                                ...vocabData[existingIndex],
                                hanViet: item.hanViet || vocabData[existingIndex].hanViet,
                                meaning: item.meaning,
                                wordType: item.wordType
                            };
                        }
                    });
                }

                // Import grammar
                if (data.grammar && data.grammar.length > 0) {
                    data.grammar.forEach(item => {
                        const existingIndex = grammarData.findIndex(g => 
                            g.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            grammarData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                        } else {
                            grammarData[existingIndex] = {
                                ...grammarData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || grammarData[existingIndex].notes
                            };
                        }
                    });
                }

                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                localStorage.setItem('grammarData', JSON.stringify(grammarData));
                renderVocab();
                renderGrammar();
            } catch (error) {
                console.error('Silent sync error:', error);
            }
        }
    </script>
</body>
</html>
