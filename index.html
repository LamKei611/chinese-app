<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Learning Notebook</title>
    
    <!-- App Icon for iOS -->
    <link rel="apple-touch-icon" href="app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chinese Notes">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8d5ba 0%, #7cb89d 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        h1 {
            font-family: 'Cherry Bomb One', cursive;
            font-weight: 400;
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        body.grammar-active {
            background: linear-gradient(135deg, #f5a9c1 0%, #e88ca7 100%);
        }

        body.pinyin-active {
            background: linear-gradient(135deg, #b8d4f1 0%, #92bee8 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .tab-button {
            padding: 12px 30px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-color: white;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44,62,80,0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(44,62,80,0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44,62,80,0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 8px 16px;
            background: rgba(44,62,80,0.1);
            color: #2c3e50;
            border: 2px solid #2c3e50;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .sort-btn:hover {
            background: #2c3e50;
            color: white;
        }

        .sort-btn.active {
            background: #2c3e50;
            color: white;
        }

        .item-list {
            display: grid;
            gap: 15px;
        }

        .vocab-item, .grammar-item, .pinyin-item {
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .vocab-item:hover, .grammar-item:hover, .pinyin-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .vocab-item {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            display: flex;
            gap: 14px;
            align-items: flex-start;
            cursor: pointer;
        }

        .vocab-item:hover {
            filter: brightness(0.97);
        }

        .hanzi {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: bold;
            min-width: 52px;
            text-align: center;
            padding-top: 2px;
        }

        .vocab-main {
            flex: 1;
        }

        .vocab-line1 {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .pinyin {
            font-size: 1em;
            color: #3d6b52;
            font-weight: 600;
        }

        .word-type {
            background: rgba(44, 62, 80, 0.12);
            color: #2c3e50;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.78em;
            font-weight: 600;
        }

        .han-viet {
            font-size: 0.88em;
            color: #5a7a65;
            font-style: italic;
        }

        .vocab-meaning {
            font-size: 0.95em;
            color: #2c3e50;
            line-height: 1.5;
        }

        .vocab-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .vocab-content.expanded {
            max-height: 300px;
        }

        .vocab-summary {
            font-size: 0.95em;
            color: #2c3e50;
            line-height: 1.5;
        }

        .expand-btn {
            background: transparent;
            color: #5a7a65;
            border: 1px solid #5a7a65;
            padding: 3px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            margin-top: 6px;
            transition: all 0.2s;
            box-shadow: none;
        }

        .expand-btn:hover {
            background: #5a7a65;
            color: white;
            transform: none;
            box-shadow: none;
        }

        .vocab-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .vocab-content-old {
            max-height: 60px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .vocab-content-old.expanded {
            max-height: 500px;
        }

        .pinyin {
            color: #34495e;
            font-weight: 600;
            font-size: 1.1em;
        }

        .han-viet {
            color: #555;
            font-style: italic;
        }

        .meaning {
            color: #333;
            font-weight: 500;
            margin-top: 5px;
        }

        .word-type {
            display: inline-block;
            padding: 4px 12px;
            background: #2c3e50;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .grammar-item {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); /* Pastel pink */
            border-left: 4px solid #2c3e50;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            cursor: pointer;
        }

        .grammar-item:hover {
            filter: brightness(0.97);
        }

        .grammar-summary {
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
            margin-bottom: 2px;
        }

        .grammar-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .grammar-notes {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .grammar-example {
            background: rgba(255,255,255,0.6);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-style: italic;
        }

        .grammar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .grammar-content.expanded {
            max-height: 1000px;
        }

        /* Pinyin Item Styles */
        .pinyin-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); /* Pastel blue */
            border-left: 4px solid #2c3e50;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            cursor: pointer;
        }

        .pinyin-item:hover {
            filter: brightness(0.97);
        }

        .pinyin-summary {
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
            margin-bottom: 2px;
        }

        .pinyin-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .pinyin-notes {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .pinyin-example {
            background: rgba(255,255,255,0.6);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-style: italic;
        }

        .pinyin-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .pinyin-content.expanded {
            max-height: 1000px;
        }

        .show-more-btn {
            background: transparent;
            color: #2c3e50;
            border: 1px solid #2c3e50;
            padding: 6px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            margin-top: 10px;
            display: inline-block;
        }

        .show-more-btn:hover {
            background: #2c3e50;
            color: white;
        }

        .delete-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .edit-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .print-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .print-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .btn-icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .print-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .select-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .google-sheets-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .google-sheets-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .sync-status {
            font-size: 0.85em;
            color: #666;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            /* ── Body & Container ── */
            body {
                padding: 0;
                padding-bottom: 80px; /* space for bottom nav */
            }

            .container {
                padding: 0;
            }

            /* ── Header ── */
            h1 {
                font-size: 1.7em;
                padding: 18px 16px 4px;
                margin-bottom: 2px;
            }

            .subtitle {
                font-size: 0.82em;
                margin-bottom: 0;
                padding: 0 16px 12px;
            }

            /* ── Hide top tab bar, use bottom nav instead ── */
            .tabs {
                display: none;
            }

            /* ── Bottom Navigation Bar ── */
            .bottom-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 -2px 16px rgba(0,0,0,0.13);
                border-top: 1px solid #e8e8e8;
            }

            .bottom-nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 7px 1px 6px;
                background: white;
                border: none;
                cursor: pointer;
                font-size: 0.54em;
                font-weight: 600;
                color: #aaa;
                gap: 2px;
                box-shadow: none;
                border-radius: 0;
                transition: color 0.2s;
            }

            .bottom-nav-btn.active {
                color: #2c3e50;
            }

            .bottom-nav-btn svg {
                width: 20px;
                height: 20px;
                fill: currentColor;
            }

            .bottom-nav-btn.sheets-btn {
                font-size: 0.52em;
                color: #95a5a6;
            }

            /* ── Section padding on mobile ── */
            .section {
                padding: 12px 12px 0;
            }

            /* ── Cards ── */
            .card {
                border-radius: 14px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            }

            .card h2 {
                font-size: 1em;
                margin-bottom: 14px !important;
            }

            /* ── Form collapsible on mobile ── */
            .mobile-form-toggle {
                display: flex !important;
                width: 100%;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 13px 18px;
                font-size: 0.92em;
                font-weight: 700;
                font-family: 'Montserrat', sans-serif;
                cursor: pointer;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                box-shadow: 0 3px 10px rgba(44,62,80,0.3);
            }

            .mobile-form-toggle:hover, .mobile-form-toggle:active {
                transform: none;
                box-shadow: 0 3px 10px rgba(44,62,80,0.3);
            }

            .form-collapsible {
                display: none;
            }

            .form-collapsible.open {
                display: block;
            }

            /* ── Form inputs ── */
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            label {
                font-size: 0.82em;
                margin-bottom: 5px;
            }

            input, select, textarea {
                padding: 10px 12px;
                font-size: 0.9em;
                border-radius: 8px;
            }

            textarea {
                min-height: 70px;
            }

            /* Submit button full-width on mobile */
            form > button[type="submit"] {
                width: 100%;
                padding: 13px;
                font-size: 0.95em;
                border-radius: 12px;
            }

            /* ── Controls bar ── */
            .controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 12px;
            }

            .controls h2 {
                font-size: 1em;
            }

            .sort-buttons {
                gap: 6px;
                width: 100%;
            }

            .sort-btn {
                padding: 6px 12px;
                font-size: 0.78em;
                flex: 1;
                text-align: center;
            }

            /* ── Selection controls ── */
            .selection-controls {
                gap: 6px;
                flex-wrap: wrap;
            }

            .selection-controls input[type="text"] {
                width: 100% !important;
                max-width: 100% !important;
                flex: unset;
                order: -1;
            }

            .select-btn {
                padding: 6px 12px;
                font-size: 0.78em;
            }

            .print-btn {
                padding: 7px 14px;
                font-size: 0.8em;
            }

            /* ── Vocab items ── */
            .vocab-item {
                padding: 13px;
                gap: 10px;
                flex-wrap: nowrap;
                border-radius: 12px;
            }

            .vocab-item:hover {
                transform: none;
            }

            .hanzi {
                font-size: 1.6em;
                min-width: 44px;
            }

            .vocab-main {
                min-width: 0; /* allow text to truncate */
            }

            .vocab-line1 {
                gap: 5px;
            }

            .pinyin {
                font-size: 0.9em;
            }

            .word-type {
                font-size: 0.7em;
                padding: 2px 7px;
            }

            .han-viet {
                font-size: 0.8em;
            }

            .vocab-summary {
                font-size: 0.85em;
            }

            .action-buttons {
                flex-direction: column;
                gap: 6px;
                flex-shrink: 0;
            }

            .edit-btn, .delete-btn {
                padding: 7px 9px;
            }

            .item-checkbox {
                width: 18px;
                height: 18px;
                margin-right: 4px;
                flex-shrink: 0;
            }

            /* ── Grammar items ── */
            .grammar-item {
                padding: 13px;
                border-radius: 12px;
            }

            .grammar-item:hover {
                transform: none;
            }

            .grammar-title {
                font-size: 1em;
                margin-bottom: 6px;
            }

            .grammar-summary {
                font-size: 0.82em;
            }

            .grammar-example {
                padding: 8px 10px;
                font-size: 0.85em;
            }

            .grammar-notes {
                font-size: 0.85em;
            }

            .expand-btn {
                font-size: 0.7em;
                padding: 3px 10px;
            }

            /* ── Pinyin items (same as grammar) ── */
            .pinyin-item {
                padding: 13px;
                border-radius: 12px;
            }

            .pinyin-item:hover {
                transform: none;
            }

            .pinyin-title {
                font-size: 1em;
                margin-bottom: 6px;
            }

            .pinyin-summary {
                font-size: 0.82em;
            }

            .pinyin-example {
                padding: 8px 10px;
                font-size: 0.85em;
            }

            .pinyin-notes {
                font-size: 0.85em;
            }
        }

        /* Bottom nav hidden on desktop */
        .bottom-nav {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chinese Learning Notebook</h1>
        <p class="subtitle">Your friendly companion for vocabulary and grammar</p>

        <!-- Desktop tab bar -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('vocab', this)">Vocabulary</button>
            <button class="tab-button" onclick="switchTab('grammar', this)">Grammar</button>
            <button class="tab-button" onclick="switchTab('pinyin-section', this)">Pinyin</button>
            <button class="google-sheets-btn" onclick="setupGoogleSheets()" style="margin-left: 20px;">Setup Sheets</button>
            <button class="google-sheets-btn" onclick="syncFromGoogleSheets()">Import from Sheets</button>
        </div>

        <!-- Mobile bottom navigation -->
        <nav class="bottom-nav" id="bottomNav">
            <button class="bottom-nav-btn active" id="mobileVocabBtn" onclick="switchTab('vocab', null); setMobileNav(this)">
                <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>
                Vocab
            </button>
            <button class="bottom-nav-btn" id="mobileGrammarBtn" onclick="switchTab('grammar', null); setMobileNav(this)">
                <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
                Grammar
            </button>
            <button class="bottom-nav-btn" id="mobilePinyinBtn" onclick="switchTab('pinyin-section', null); setMobileNav(this)">
                <svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                Pinyin
            </button>
            <button class="bottom-nav-btn sheets-btn" onclick="syncFromGoogleSheets()">
                <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.07-.44.18-.88.18-1.34C18 2.54 15.46 0 12.34 0c-1.7 0-3.2.8-4.19 2.04L7 3.5l-1.15-1.46C4.86.8 3.36 0 1.66 0 .74 0 0 .74 0 1.66v.01C0 3.77 1.56 5.5 3.59 5.85c.13.02.27.03.41.04V6H2c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM12 16.5l-4-4h2.5V9h3v3.5H16l-4 4z"/></svg>
                Import
            </button>
            <button class="bottom-nav-btn sheets-btn" onclick="setupGoogleSheets()">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.63-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                Setup
            </button>
        </nav>

        <!-- Vocabulary Section -->
        <div id="vocab" class="section active">
            <div class="card">
                <button class="mobile-form-toggle" onclick="toggleMobileForm('vocabFormCollapse', this)" style="display:none;">
                    <span>➕ Add New Word</span>
                    <span class="toggle-arrow">▼</span>
                </button>
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Word</h2>
                <div class="form-collapsible open" id="vocabFormCollapse">
                <form id="vocabForm" onsubmit="addVocab(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hanzi (汉字)</label>
                            <input type="text" id="hanzi" required placeholder="例如: 你好">
                        </div>
                        <div class="form-group">
                            <label>Pinyin</label>
                            <input type="text" id="pinyin" required placeholder="nǐ hǎo">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hán Việt</label>
                            <input type="text" id="hanViet" placeholder="nhĩ hảo">
                        </div>
                        <div class="form-group">
                            <label>Type of Word</label>
                            <input type="text" id="wordType" list="wordTypeOptions" required placeholder="Select or type your own...">
                            <datalist id="wordTypeOptions">
                                <option value="Noun (Danh từ)">
                                <option value="Verb (Động từ)">
                                <option value="Adjective (Tính từ)">
                                <option value="Adverb (Trạng từ)">
                                <option value="Phrase (Cụm từ)">
                                <option value="Other (Khác)">
                            </datalist>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Vietnamese Meaning</label>
                        <textarea id="meaning" required placeholder="Xin chào" rows="3"></textarea>
                    </div>
                    <button type="submit">Add Word</button>
                </form>
                </div>
            </div>

            <div class="card">
                <div class="controls">
                    <h2 style="color: #2c3e50;">My Vocabulary</h2>
                    <div class="sort-buttons">
                        <button class="sort-btn" onclick="sortVocab('date')">By Date</button>
                        <button class="sort-btn" onclick="sortVocab('hanzi')">By Hanzi</button>
                        <button class="sort-btn" onclick="sortVocab('type')">By Type</button>
                        <button class="print-btn" onclick="printVocabPDF()" title="Print Selected">
                            <svg class="print-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div class="selection-controls">
                    <input type="text" id="vocabSearch" placeholder="Search vocabulary..." onkeyup="searchVocab()" style="flex: 1; max-width: 300px;">
                    <button class="select-btn" onclick="toggleSelectAllVocab()">Select All</button>
                    <button class="select-btn" onclick="deselectAllVocab()">Deselect All</button>
                    <span id="vocabSelectedCount" class="sync-status"></span>
                </div>
                <div id="vocabList" class="item-list"></div>
            </div>
        </div>

        <!-- Grammar Section -->
        <div id="grammar" class="section">
            <div class="card">
                <button class="mobile-form-toggle" onclick="toggleMobileForm('grammarFormCollapse', this)" style="display:none;">
                    <span>➕ Add New Grammar</span>
                    <span class="toggle-arrow">▼</span>
                </button>
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Grammar</h2>
                <div class="form-collapsible open" id="grammarFormCollapse">
                <form id="grammarForm" onsubmit="addGrammar(event)">
                    <div class="form-group">
                        <label>Grammar Pattern</label>
                        <input type="text" id="grammarPattern" required placeholder="例如: 不是...而是...">
                    </div>
                    <div class="form-group">
                        <label>Examples</label>
                        <textarea id="grammarExamples" required placeholder="他不是老师，而是学生。&#10;Anh ấy không phải là giáo viên mà là học sinh."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="grammarNotes" placeholder="Usage notes, tips, and explanations..."></textarea>
                    </div>
                    <button type="submit">Add Grammar</button>
                </form>
                </div>
            </div>

            <div class="card">
                <div class="controls">
                    <h2 style="color: #2c3e50;">My Grammar Notes</h2>
                    <div class="sort-buttons">
                        <button class="sort-btn" onclick="sortGrammar('date')">By Date</button>
                        <button class="sort-btn" onclick="sortGrammar('pattern')">By Pattern</button>
                        <button class="print-btn" onclick="printGrammarPDF()" title="Print Selected">
                            <svg class="print-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div class="selection-controls">
                    <input type="text" id="grammarSearch" placeholder="Search grammar..." onkeyup="searchGrammar()" style="flex: 1; max-width: 300px;">
                    <button class="select-btn" onclick="toggleSelectAllGrammar()">Select All</button>
                    <button class="select-btn" onclick="deselectAllGrammar()">Deselect All</button>
                    <span id="grammarSelectedCount" class="sync-status"></span>
                </div>
                <div id="grammarList" class="item-list"></div>
            </div>
        </div>

        <!-- Pinyin Section -->
        <div id="pinyin-section" class="section">
            <div class="card">
                <button class="mobile-form-toggle" onclick="toggleMobileForm('pinyinFormCollapse', this)" style="display:none;">
                    <span>➕ Add New Pinyin</span>
                    <span class="toggle-arrow">▼</span>
                </button>
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Pinyin</h2>
                <div class="form-collapsible open" id="pinyinFormCollapse">
                <form id="pinyinForm" onsubmit="addPinyin(event)">
                    <div class="form-group">
                        <label>Pinyin Part</label>
                        <input type="text" id="pinyinPattern" required placeholder="例如: zh, ch, sh, ...">
                    </div>
                    <div class="form-group">
                        <label>Pronunciation</label>
                        <textarea id="pinyinExamples" required placeholder="zhī, zhá, zhǎ, zhà..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="pinyinNotes" placeholder="Usage notes, tips, and explanations..."></textarea>
                    </div>
                    <button type="submit">Add Pinyin</button>
                </form>
                </div>
            </div>

            <div class="card">
                <div class="controls">
                    <h2 style="color: #2c3e50;">My Pinyin Notes</h2>
                    <div class="sort-buttons">
                        <button class="sort-btn" onclick="sortPinyin('date')">By Date</button>
                        <button class="sort-btn" onclick="sortPinyin('pattern')">By Pattern</button>
                        <button class="print-btn" onclick="printPinyinPDF()" title="Print Selected">
                            <svg class="print-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div class="selection-controls">
                    <input type="text" id="pinyinSearch" placeholder="Search pinyin..." onkeyup="searchPinyin()" style="flex: 1; max-width: 300px;">
                    <button class="select-btn" onclick="toggleSelectAllPinyin()">Select All</button>
                    <button class="select-btn" onclick="deselectAllPinyin()">Deselect All</button>
                    <span id="pinyinSelectedCount" class="sync-status"></span>
                </div>
                <div id="pinyinList" class="item-list"></div>
            </div>
        </div>

    </div>

    <script>
        // Initialize data from localStorage
        let vocabData = JSON.parse(localStorage.getItem('vocabData')) || [];
        let grammarData = JSON.parse(localStorage.getItem('grammarData')) || [];
        let pinyinData = JSON.parse(localStorage.getItem('pinyinData')) || [];
        let editingVocabId = null;
        let editingGrammarId = null;
        let editingPinyinId = null;
        let googleSheetsUrl = localStorage.getItem('googleSheetsUrl') || null;
        let googleSheetId = localStorage.getItem('googleSheetId') || null;

        // Switch between tabs
        function switchTab(tab, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (btn) btn.classList.add('active');
            document.body.classList.remove('grammar-active', 'pinyin-active');
            if (tab === 'grammar') document.body.classList.add('grammar-active');
            if (tab === 'pinyin-section') document.body.classList.add('pinyin-active');
        }

        // Mobile bottom nav highlight
        function setMobileNav(btn) {
            document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Toggle collapsible form on mobile
        function toggleMobileForm(collapseId, toggleBtn) {
            const form = document.getElementById(collapseId);
            const arrow = toggleBtn.querySelector('.toggle-arrow');
            if (form.classList.contains('open')) {
                form.classList.remove('open');
                arrow.textContent = '▼';
            } else {
                form.classList.add('open');
                arrow.textContent = '▲';
            }
        }

        // On mobile: show toggle button, hide h2, collapse form by default
        function initMobileForms() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.mobile-form-toggle').forEach(btn => {
                    btn.style.display = 'flex';
                });
                document.querySelectorAll('.form-collapsible').forEach(f => {
                    f.classList.remove('open');
                });
                // Hide the static h2 headings inside form cards
                document.querySelectorAll('.card h2').forEach(h2 => {
                    if (h2.textContent.includes('Add New')) h2.style.display = 'none';
                });
            }
        }

        window.addEventListener('DOMContentLoaded', initMobileForms);
        window.addEventListener('resize', initMobileForms);

        // Add or edit vocabulary
        function addVocab(event) {
            event.preventDefault();
            
            const vocab = {
                id: editingVocabId || Date.now(),
                hanzi: document.getElementById('hanzi').value,
                pinyin: document.getElementById('pinyin').value,
                hanViet: document.getElementById('hanViet').value,
                wordType: document.getElementById('wordType').value,
                meaning: document.getElementById('meaning').value,
                date: editingVocabId ? vocabData.find(v => v.id === editingVocabId).date : new Date().toISOString()
            };

            if (editingVocabId) {
                const index = vocabData.findIndex(v => v.id === editingVocabId);
                vocabData[index] = vocab;
                editingVocabId = null;
                document.querySelector('#vocabForm button[type="submit"]').textContent = 'Add Word';
            } else {
                vocabData.push(vocab);
            }

            localStorage.setItem('vocabData', JSON.stringify(vocabData));
            
            document.getElementById('vocabForm').reset();
            renderVocab();
            
            // Auto-sync to Google Sheets
            if (googleSheetsUrl) {
                syncToGoogleSheets();
            }
        }

        // Add or edit grammar
        function addGrammar(event) {
            event.preventDefault();
            
            const grammar = {
                id: editingGrammarId || Date.now(),
                pattern: document.getElementById('grammarPattern').value,
                examples: document.getElementById('grammarExamples').value,
                notes: document.getElementById('grammarNotes').value,
                date: editingGrammarId ? grammarData.find(g => g.id === editingGrammarId).date : new Date().toISOString()
            };

            if (editingGrammarId) {
                const index = grammarData.findIndex(g => g.id === editingGrammarId);
                grammarData[index] = grammar;
                editingGrammarId = null;
                document.querySelector('#grammarForm button[type="submit"]').textContent = 'Add Grammar';
            } else {
                grammarData.push(grammar);
            }

            localStorage.setItem('grammarData', JSON.stringify(grammarData));
            
            document.getElementById('grammarForm').reset();
            renderGrammar();
            
            // Auto-sync to Google Sheets
            if (googleSheetsUrl) {
                syncToGoogleSheets();
            }
        }

        // Sort vocabulary
        function sortVocab(by) {
            document.querySelectorAll('#vocab .sort-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (by === 'date') {
                vocabData.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (by === 'hanzi') {
                vocabData.sort((a, b) => a.hanzi.localeCompare(b.hanzi));
            } else if (by === 'type') {
                vocabData.sort((a, b) => a.wordType.localeCompare(b.wordType));
            }
            
            renderVocab();
        }

        // Sort grammar
        function sortGrammar(by) {
            document.querySelectorAll('#grammar .sort-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (by === 'date') {
                grammarData.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (by === 'pattern') {
                grammarData.sort((a, b) => a.pattern.localeCompare(b.pattern));
            }
            
            renderGrammar();
        }

        // Edit vocabulary
        function editVocab(id) {
            const vocab = vocabData.find(v => v.id === id);
            if (!vocab) return;

            document.getElementById('hanzi').value = vocab.hanzi;
            document.getElementById('pinyin').value = vocab.pinyin;
            document.getElementById('hanViet').value = vocab.hanViet;
            document.getElementById('wordType').value = vocab.wordType;
            document.getElementById('meaning').value = vocab.meaning;

            editingVocabId = id;
            document.querySelector('#vocabForm button[type="submit"]').textContent = 'Update Word';
            
            // Scroll to form
            document.getElementById('vocabForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Edit grammar
        function editGrammar(id) {
            const grammar = grammarData.find(g => g.id === id);
            if (!grammar) return;

            document.getElementById('grammarPattern').value = grammar.pattern;
            document.getElementById('grammarExamples').value = grammar.examples;
            document.getElementById('grammarNotes').value = grammar.notes;

            editingGrammarId = id;
            document.querySelector('#grammarForm button[type="submit"]').textContent = 'Update Grammar';
            
            // Scroll to form
            document.getElementById('grammarForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Delete vocabulary
        function deleteVocab(id) {
            if (confirm('Are you sure you want to delete this word?')) {
                vocabData = vocabData.filter(v => v.id !== id);
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                renderVocab();
                
                // Sync to Google Sheets
                if (googleSheetsUrl) {
                    syncToGoogleSheets();
                }
            }
        }

        // Delete grammar
        function deleteGrammar(id) {
            if (confirm('Are you sure you want to delete this grammar note?')) {
                grammarData = grammarData.filter(g => g.id !== id);
                localStorage.setItem('grammarData', JSON.stringify(grammarData));
                renderGrammar();
                
                // Sync to Google Sheets
                if (googleSheetsUrl) {
                    syncToGoogleSheets();
                }
            }
        }

        // Render vocabulary list
        function renderVocab() {
            const list = document.getElementById('vocabList');
            
            if (vocabData.length === 0) {
                list.innerHTML = '<div class="empty-state">No vocabulary yet. Add your first word!</div>';
                document.getElementById('vocabSelectedCount').textContent = '';
                return;
            }

            list.innerHTML = vocabData.map(v => {
                const isLong = v.meaning.length > 60;
                const preview = isLong ? v.meaning.substring(0, 60) + '…' : v.meaning;
                return `
                <div class="vocab-item">
                    <input type="checkbox" class="item-checkbox vocab-checkbox" data-id="${v.id}" onchange="updateVocabCount()" onclick="event.stopPropagation()">
                    <div class="hanzi">${v.hanzi}</div>
                    <div class="vocab-main">
                        <div class="vocab-line1">
                            <span class="pinyin">${v.pinyin}</span>
                            <span class="word-type">${v.wordType}</span>
                            ${v.hanViet ? `<span class="han-viet">${v.hanViet}</span>` : ''}
                        </div>
                        <div class="vocab-summary" id="vocab-summary-${v.id}">${preview}</div>
                        <div class="vocab-content" id="vocab-content-${v.id}">
                            ${isLong ? `<div style="margin-top:4px; font-size:0.93em; color:#2c3e50; line-height:1.6;">${v.meaning}</div>` : ''}
                        </div>
                        ${isLong ? `<button class="expand-btn" id="vocab-hint-${v.id}" onclick="toggleVocabContent(${v.id}, event)">Show more ▼</button>` : ''}
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editVocab(${v.id})" title="Edit">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-btn" onclick="deleteVocab(${v.id})" title="Delete">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
            updateVocabCount();
        }

        // Render grammar list
        function renderGrammar() {
            const list = document.getElementById('grammarList');
            
            if (grammarData.length === 0) {
                list.innerHTML = '<div class="empty-state">No grammar notes yet. Add your first pattern!</div>';
                document.getElementById('grammarSelectedCount').textContent = '';
                return;
            }

            list.innerHTML = grammarData.map(g => {
                const notesPreview = g.notes ? (g.notes.length > 70 ? g.notes.substring(0,70) + '…' : g.notes) : '';
                const exPreview = g.examples ? (g.examples.length > 70 ? g.examples.substring(0,70) + '…' : g.examples) : '';
                const preview = notesPreview || exPreview;
                return `
                <div class="grammar-item">
                    <input type="checkbox" class="item-checkbox grammar-checkbox" data-id="${g.id}" onchange="updateGrammarCount()" onclick="event.stopPropagation()">
                    <div style="flex: 1;">
                        <div class="grammar-title">${g.pattern}</div>
                        <div class="grammar-summary" id="grammar-summary-${g.id}">${preview}</div>
                        <div class="grammar-content" id="grammar-content-${g.id}">
                            ${g.notes ? `<div class="grammar-notes"><strong>Notes:</strong> ${g.notes}</div>` : ''}
                            <div class="grammar-example"><strong>Examples:</strong><br>${g.examples.replace(/\n/g, '<br>')}</div>
                        </div>
                        <button class="expand-btn" id="grammar-hint-${g.id}" onclick="toggleGrammarContent(${g.id})">Show more ▼</button>
                    </div>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="edit-btn" onclick="editGrammar(${g.id})" title="Edit">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-btn" onclick="deleteGrammar(${g.id})" title="Delete">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
            updateGrammarCount();
        }

        // Initial render
        renderVocab();
        renderGrammar();
        renderPinyin();
        
        // Auto-sync from Google Sheets on load (for cross-device sync)
        if (googleSheetsUrl) {
            syncFromGoogleSheetsSilent();
        }

        // Selection functions
        function toggleSelectAllVocab() {
            const checkboxes = document.querySelectorAll('.vocab-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateVocabCount();
        }

        function deselectAllVocab() {
            document.querySelectorAll('.vocab-checkbox').forEach(cb => cb.checked = false);
            updateVocabCount();
        }

        function toggleSelectAllGrammar() {
            const checkboxes = document.querySelectorAll('.grammar-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateGrammarCount();
        }

        function deselectAllGrammar() {
            document.querySelectorAll('.grammar-checkbox').forEach(cb => cb.checked = false);
            updateGrammarCount();
        }

        function updateVocabCount() {
            const selected = document.querySelectorAll('.vocab-checkbox:checked').length;
            const total = vocabData.length;
            document.getElementById('vocabSelectedCount').textContent = 
                selected > 0 ? `${selected} of ${total} selected` : '';
        }

        function updateGrammarCount() {
            const selected = document.querySelectorAll('.grammar-checkbox:checked').length;
            const total = grammarData.length;
            document.getElementById('grammarSelectedCount').textContent = 
                selected > 0 ? `${selected} of ${total} selected` : '';
        }

        // Search functions
        function searchVocab() {
            const searchTerm = document.getElementById('vocabSearch').value.toLowerCase();
            const items = document.querySelectorAll('.vocab-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'grid';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function searchGrammar() {
            const searchTerm = document.getElementById('grammarSearch').value.toLowerCase();
            const items = document.querySelectorAll('.grammar-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Toggle vocabulary content expansion
        function toggleVocabContent(id, event) {
            if (event) event.stopPropagation();
            const content = document.getElementById(`vocab-content-${id}`);
            const summary = document.getElementById(`vocab-summary-${id}`);
            const btn = document.getElementById(`vocab-hint-${id}`);
            if (!content) return;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (summary) summary.style.display = '';
                if (btn) btn.textContent = 'Show more ▼';
            } else {
                content.classList.add('expanded');
                if (summary) summary.style.display = 'none';
                if (btn) btn.textContent = 'Show less ▲';
            }
        }

        // Toggle grammar content expansion
        function toggleGrammarContent(id) {
            const content = document.getElementById(`grammar-content-${id}`);
            const summary = document.getElementById(`grammar-summary-${id}`);
            const btn = document.getElementById(`grammar-hint-${id}`);
            if (!content) return;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (summary) summary.style.display = '';
                if (btn) btn.textContent = 'Show more ▼';
            } else {
                content.classList.add('expanded');
                if (summary) summary.style.display = 'none';
                if (btn) btn.textContent = 'Show less ▲';
            }
        }

        // Print Vocabulary (only selected)
        async function printVocabPDF() {
            // First, try to sync from Google Sheets to get latest data
            if (googleSheetsUrl) {
                await syncFromGoogleSheetsSilent();
            }
            
            const selectedCheckboxes = document.querySelectorAll('.vocab-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one word to print!');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            const selectedVocab = vocabData.filter(v => selectedIds.includes(v.id));

            // Create a printable HTML page
            const printWindow = window.open('', '', 'width=800,height=600');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>My Chinese Vocabulary</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                        }
                        .date {
                            color: #666;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        td {
                            border: 1px solid #ddd;
                            padding: 10px;
                        }
                        tr:nth-child(even) {
                            background-color: #f5f7fa;
                        }
                        .hanzi {
                            font-size: 20px;
                            font-weight: bold;
                            text-align: center;
                        }
                        .type {
                            text-align: center;
                            font-size: 13px;
                        }
                        .footer {
                            color: #666;
                            font-size: 14px;
                            margin-top: 20px;
                        }
                        @media print {
                            body {
                                padding: 10px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>My Chinese Vocabulary</h1>
                    <div class="date">Generated: ${new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%;">Hanzi</th>
                                <th style="width: 20%;">Pinyin</th>
                                <th style="width: 20%;">Hán Việt</th>
                                <th style="width: 30%;">Meaning</th>
                                <th style="width: 15%;">Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedVocab.map(v => `
                                <tr>
                                    <td class="hanzi">${v.hanzi}</td>
                                    <td>${v.pinyin}</td>
                                    <td>${v.hanViet || '-'}</td>
                                    <td>${v.meaning}</td>
                                    <td class="type">${v.wordType}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">Total words: ${selectedVocab.length}</div>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Print Grammar (only selected)
        async function printGrammarPDF() {
            // First, try to sync from Google Sheets to get latest data
            if (googleSheetsUrl) {
                await syncFromGoogleSheetsSilent();
            }
            
            const selectedCheckboxes = document.querySelectorAll('.grammar-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one grammar pattern to print!');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            const selectedGrammar = grammarData.filter(g => selectedIds.includes(g.id));

            // Create a printable HTML page
            const printWindow = window.open('', '', 'width=800,height=600');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>My Chinese Grammar Notes</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                        }
                        .date {
                            color: #666;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            vertical-align: top;
                        }
                        tr:nth-child(even) {
                            background-color: #f5f7fa;
                        }
                        .pattern {
                            font-size: 16px;
                            font-weight: bold;
                        }
                        .examples {
                            white-space: pre-line;
                            line-height: 1.6;
                        }
                        .footer {
                            color: #666;
                            font-size: 14px;
                            margin-top: 20px;
                        }
                        @media print {
                            body {
                                padding: 10px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>My Chinese Grammar Notes</h1>
                    <div class="date">Generated: ${new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 25%;">Grammar Pattern</th>
                                <th style="width: 45%;">Examples</th>
                                <th style="width: 30%;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedGrammar.map(g => `
                                <tr>
                                    <td class="pattern">${g.pattern}</td>
                                    <td class="examples">${g.examples}</td>
                                    <td>${g.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">Total grammar patterns: ${selectedGrammar.length}</div>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // ========== PINYIN FUNCTIONS ==========
        // Add or edit pinyin
        function addPinyin(event) {
            event.preventDefault();
            
            const pinyin = {
                id: editingPinyinId || Date.now(),
                pattern: document.getElementById('pinyinPattern').value,
                examples: document.getElementById('pinyinExamples').value,
                notes: document.getElementById('pinyinNotes').value,
                date: editingPinyinId ? pinyinData.find(p => p.id === editingPinyinId).date : new Date().toISOString()
            };

            if (editingPinyinId) {
                const index = pinyinData.findIndex(p => p.id === editingPinyinId);
                pinyinData[index] = pinyin;
                editingPinyinId = null;
                document.querySelector('#pinyinForm button[type="submit"]').textContent = 'Add Pinyin';
            } else {
                pinyinData.push(pinyin);
            }

            localStorage.setItem('pinyinData', JSON.stringify(pinyinData));
            document.getElementById('pinyinForm').reset();
            renderPinyin();
            syncToGoogleSheets();
        }

        // Sort pinyin
        function sortPinyin(by) {
            if (by === 'date') {
                pinyinData.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (by === 'pattern') {
                pinyinData.sort((a, b) => a.pattern.localeCompare(b.pattern));
            }
            renderPinyin();
        }

        // Edit pinyin
        function editPinyin(id) {
            const pinyin = pinyinData.find(p => p.id === id);
            if (!pinyin) return;

            document.getElementById('pinyinPattern').value = pinyin.pattern;
            document.getElementById('pinyinExamples').value = pinyin.examples;
            document.getElementById('pinyinNotes').value = pinyin.notes;
            editingPinyinId = id;

            document.querySelector('#pinyinForm button[type="submit"]').textContent = 'Update Pinyin';
            document.getElementById('pinyinForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Delete pinyin
        function deletePinyin(id) {
            if (!confirm('Delete this pinyin note?')) return;
            pinyinData = pinyinData.filter(p => p.id !== id);
            localStorage.setItem('pinyinData', JSON.stringify(pinyinData));
            renderPinyin();
            syncToGoogleSheets();
        }

        // Render pinyin list
        function renderPinyin() {
            const list = document.getElementById('pinyinList');
            
            if (pinyinData.length === 0) {
                list.innerHTML = '<div class="empty-state">No pinyin notes yet. Add your first one!</div>';
                document.getElementById('pinyinSelectedCount').textContent = '';
                return;
            }

            list.innerHTML = pinyinData.map(p => {
                const notesPreview = p.notes ? (p.notes.length > 70 ? p.notes.substring(0,70) + '…' : p.notes) : '';
                const exPreview = p.examples ? (p.examples.length > 70 ? p.examples.substring(0,70) + '…' : p.examples) : '';
                const preview = notesPreview || exPreview;
                return `
                <div class="pinyin-item">
                    <input type="checkbox" class="item-checkbox pinyin-checkbox" data-id="${p.id}" onchange="updatePinyinCount()" onclick="event.stopPropagation()">
                    <div style="flex: 1;">
                        <div class="pinyin-title">${p.pattern}</div>
                        <div class="pinyin-summary" id="pinyin-summary-${p.id}">${preview}</div>
                        <div class="pinyin-content" id="pinyin-content-${p.id}">
                            ${p.notes ? `<div class="pinyin-notes"><strong>Notes:</strong> ${p.notes}</div>` : ''}
                            <div class="pinyin-example"><strong>Pronunciation:</strong><br>${p.examples.replace(/\n/g, '<br>')}</div>
                        </div>
                        <button class="expand-btn" id="pinyin-hint-${p.id}" onclick="togglePinyinContent(${p.id})">Show more ▼</button>
                    </div>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="edit-btn" onclick="editPinyin(${p.id})" title="Edit">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-btn" onclick="deletePinyin(${p.id})" title="Delete">
                            <svg class="btn-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
            updatePinyinCount();
        }

        // Selection functions for pinyin
        function toggleSelectAllPinyin() {
            const checkboxes = document.querySelectorAll('.pinyin-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updatePinyinCount();
        }

        function deselectAllPinyin() {
            document.querySelectorAll('.pinyin-checkbox').forEach(cb => cb.checked = false);
            updatePinyinCount();
        }

        function updatePinyinCount() {
            const selected = document.querySelectorAll('.pinyin-checkbox:checked').length;
            const total = pinyinData.length;
            document.getElementById('pinyinSelectedCount').textContent = 
                selected > 0 ? `${selected} of ${total} selected` : '';
        }

        // Search pinyin
        function searchPinyin() {
            const query = document.getElementById('pinyinSearch').value.toLowerCase();
            const items = document.querySelectorAll('.pinyin-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Toggle pinyin content expansion
        function togglePinyinContent(id) {
            const content = document.getElementById(`pinyin-content-${id}`);
            const summary = document.getElementById(`pinyin-summary-${id}`);
            const btn = document.getElementById(`pinyin-hint-${id}`);
            if (!content) return;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (summary) summary.style.display = '';
                if (btn) btn.textContent = 'Show more ▼';
            } else {
                content.classList.add('expanded');
                if (summary) summary.style.display = 'none';
                if (btn) btn.textContent = 'Show less ▲';
            }
        }

        // Print Pinyin (only selected)
        async function printPinyinPDF() {
            if (googleSheetsUrl) {
                await syncFromGoogleSheetsSilent();
            }
            
            const selectedCheckboxes = document.querySelectorAll('.pinyin-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one pinyin to print!');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            const selectedPinyin = pinyinData.filter(p => selectedIds.includes(p.id));

            const printWindow = window.open('', '', 'width=800,height=600');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Pinyin Notes</title>
                    <style>
                        @page { margin: 20mm; }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Montserrat', Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            padding: 20px;
                        }
                        h1 { 
                            color: #2c3e50;
                            margin-bottom: 30px;
                            text-align: center;
                            font-size: 28px;
                        }
                        .pinyin-item {
                            margin-bottom: 30px;
                            padding: 20px;
                            border: 2px solid #bbdefb;
                            border-radius: 10px;
                            background: #e3f2fd;
                            page-break-inside: avoid;
                        }
                        .pattern {
                            font-size: 22px;
                            font-weight: bold;
                            color: #2c3e50;
                            margin-bottom: 10px;
                        }
                        .label {
                            font-weight: 600;
                            color: #1976d2;
                            margin-top: 10px;
                        }
                        .content {
                            margin-top: 5px;
                            padding-left: 10px;
                            white-space: pre-wrap;
                        }
                    </style>
                </head>
                <body>
                    <h1>Pinyin Notes</h1>
                    ${selectedPinyin.map(p => `
                        <div class="pinyin-item">
                            <div class="pattern">${p.pattern}</div>
                            ${p.notes ? `<div class="label">Notes:</div><div class="content">${p.notes}</div>` : ''}
                            <div class="label">Pronunciation:</div>
                            <div class="content">${p.examples}</div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Google Sheets Integration
        function setupGoogleSheets() {
            const instructions = `
To sync with Google Sheets (TWO-WAY SYNC):

1. Create a new Google Sheet
2. Go to Extensions → Apps Script
3. Delete any code and paste the NEW code (see next step)
4. Deploy as Web App
5. Copy BOTH the Web App URL AND your Google Sheet URL

The app will show you the code to paste in the next step.

Ready to continue?`;

            if (!confirm(instructions)) return;

            const code = `function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var data = JSON.parse(e.postData.contents);
  
  if (data.type === 'vocab') {
    var vocabSheet = sheet.getSheetByName('Vocabulary') || sheet.insertSheet('Vocabulary');
    vocabSheet.clear();
    vocabSheet.appendRow(['Hanzi', 'Pinyin', 'Hán Việt', 'Meaning', 'Type', 'Date']);
    data.items.forEach(item => {
      vocabSheet.appendRow([item.hanzi, item.pinyin, item.hanViet, item.meaning, item.wordType, item.date]);
    });
  } else if (data.type === 'grammar') {
    var grammarSheet = sheet.getSheetByName('Grammar') || sheet.insertSheet('Grammar');
    grammarSheet.clear();
    grammarSheet.appendRow(['Pattern', 'Examples', 'Notes', 'Date']);
    data.items.forEach(item => {
      grammarSheet.appendRow([item.pattern, item.examples, item.notes, item.date]);
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var result = {};
  
  // Get vocabulary
  var vocabSheet = sheet.getSheetByName('Vocabulary');
  if (vocabSheet) {
    var vocabData = vocabSheet.getDataRange().getValues();
    result.vocab = vocabData.slice(1).map(row => ({
      hanzi: row[0],
      pinyin: row[1],
      hanViet: row[2],
      meaning: row[3],
      wordType: row[4],
      date: row[5]
    }));
  }
  
  // Get grammar
  var grammarSheet = sheet.getSheetByName('Grammar');
  if (grammarSheet) {
    var grammarData = grammarSheet.getDataRange().getValues();
    result.grammar = grammarData.slice(1).map(row => ({
      pattern: row[0],
      examples: row[1],
      notes: row[2],
      date: row[3]
    }));
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}`;

            alert('Copy this code to paste into Apps Script:\n\n' + code);

            const url = prompt('Step 1: Paste your Web App URL here:');
            if (!url) return;

            const sheetUrl = prompt('Step 2: Paste your Google Sheet URL here (e.g., https://docs.google.com/spreadsheets/d/ABC123...)');
            if (!sheetUrl) return;

            // Extract sheet ID from URL
            const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                googleSheetId = match[1];
                googleSheetsUrl = url;
                localStorage.setItem('googleSheetsUrl', url);
                localStorage.setItem('googleSheetId', googleSheetId);
                alert('Google Sheets connected! You can now sync both ways:\n• App → Sheets (automatic)\n• Sheets → App (click "Import from Sheets")');
                syncToGoogleSheets();
            } else {
                alert('Invalid Google Sheet URL. Please try again.');
            }
        }

        async function syncToGoogleSheets() {
            if (!googleSheetsUrl) return;

            try {
                // Sync vocabulary
                await fetch(googleSheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'vocab',
                        items: vocabData
                    })
                });

                // Sync grammar
                await fetch(googleSheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'grammar',
                        items: grammarData
                    })
                });

                // Sync pinyin
                await fetch(googleSheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'pinyin',
                        items: pinyinData
                    })
                });

                console.log('Synced to Google Sheets');
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        // Import data FROM Google Sheets
        async function syncFromGoogleSheets() {
            if (!googleSheetsUrl) {
                alert('Please setup Google Sheets connection first!');
                return;
            }

            if (!confirm('This will import data from Google Sheets and merge with your current data. Continue?')) {
                return;
            }

            try {
                const response = await fetch(googleSheetsUrl);
                const data = await response.json();

                let importedVocab = 0;
                let importedGrammar = 0;
                let importedPinyin = 0;

                // Import vocabulary
                if (data.vocab && data.vocab.length > 0) {
                    data.vocab.forEach(item => {
                        // Check if item already exists by matching hanzi and pinyin
                        const existingIndex = vocabData.findIndex(v => 
                            v.hanzi === item.hanzi && v.pinyin === item.pinyin
                        );
                        
                        if (existingIndex === -1) {
                            // Add new item with unique ID
                            vocabData.push({
                                id: Date.now() + Math.random(),
                                hanzi: item.hanzi,
                                pinyin: item.pinyin,
                                hanViet: item.hanViet || '',
                                meaning: item.meaning,
                                wordType: item.wordType,
                                date: item.date || new Date().toISOString()
                            });
                            importedVocab++;
                        } else {
                            // Update existing item
                            vocabData[existingIndex] = {
                                ...vocabData[existingIndex],
                                hanViet: item.hanViet || vocabData[existingIndex].hanViet,
                                meaning: item.meaning,
                                wordType: item.wordType
                            };
                        }
                    });
                }

                // Import grammar
                if (data.grammar && data.grammar.length > 0) {
                    data.grammar.forEach(item => {
                        // Check if item already exists by pattern
                        const existingIndex = grammarData.findIndex(g => 
                            g.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            // Add new item with unique ID
                            grammarData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                            importedGrammar++;
                        } else {
                            // Update existing item
                            grammarData[existingIndex] = {
                                ...grammarData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || grammarData[existingIndex].notes
                            };
                        }
                    });
                }

                // Import pinyin
                if (data.pinyin && data.pinyin.length > 0) {
                    data.pinyin.forEach(item => {
                        // Check if item already exists by pattern
                        const existingIndex = pinyinData.findIndex(p => 
                            p.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            // Add new item with unique ID
                            pinyinData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                            importedPinyin++;
                        } else {
                            // Update existing item
                            pinyinData[existingIndex] = {
                                ...pinyinData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || pinyinData[existingIndex].notes
                            };
                        }
                    });
                }

                // Save to localStorage
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                localStorage.setItem('grammarData', JSON.stringify(grammarData));
                localStorage.setItem('pinyinData', JSON.stringify(pinyinData));

                // Re-render
                renderVocab();
                renderGrammar();
                renderPinyin();

                alert(`Successfully imported!\nNew vocabulary: ${importedVocab}\nNew grammar: ${importedGrammar}\nNew pinyin: ${importedPinyin}`);
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing from Google Sheets. Make sure:\n1. You deployed the script with doGet() function\n2. Access is set to "Anyone"\n3. The URL is correct');
            }
        }

        // Silent sync (no alerts) for use before printing
        async function syncFromGoogleSheetsSilent() {
            if (!googleSheetsUrl) return;

            try {
                const response = await fetch(googleSheetsUrl);
                const data = await response.json();

                // Import vocabulary
                if (data.vocab && data.vocab.length > 0) {
                    data.vocab.forEach(item => {
                        const existingIndex = vocabData.findIndex(v => 
                            v.hanzi === item.hanzi && v.pinyin === item.pinyin
                        );
                        
                        if (existingIndex === -1) {
                            vocabData.push({
                                id: Date.now() + Math.random(),
                                hanzi: item.hanzi,
                                pinyin: item.pinyin,
                                hanViet: item.hanViet || '',
                                meaning: item.meaning,
                                wordType: item.wordType,
                                date: item.date || new Date().toISOString()
                            });
                        } else {
                            vocabData[existingIndex] = {
                                ...vocabData[existingIndex],
                                hanViet: item.hanViet || vocabData[existingIndex].hanViet,
                                meaning: item.meaning,
                                wordType: item.wordType
                            };
                        }
                    });
                }

                // Import grammar
                if (data.grammar && data.grammar.length > 0) {
                    data.grammar.forEach(item => {
                        const existingIndex = grammarData.findIndex(g => 
                            g.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            grammarData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                        } else {
                            grammarData[existingIndex] = {
                                ...grammarData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || grammarData[existingIndex].notes
                            };
                        }
                    });
                }

                // Import pinyin
                if (data.pinyin && data.pinyin.length > 0) {
                    data.pinyin.forEach(item => {
                        const existingIndex = pinyinData.findIndex(p => 
                            p.pattern === item.pattern
                        );
                        
                        if (existingIndex === -1) {
                            pinyinData.push({
                                id: Date.now() + Math.random(),
                                pattern: item.pattern,
                                examples: item.examples,
                                notes: item.notes || '',
                                date: item.date || new Date().toISOString()
                            });
                        } else {
                            pinyinData[existingIndex] = {
                                ...pinyinData[existingIndex],
                                examples: item.examples,
                                notes: item.notes || pinyinData[existingIndex].notes
                            };
                        }
                    });
                }

                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                localStorage.setItem('grammarData', JSON.stringify(grammarData));
                localStorage.setItem('pinyinData', JSON.stringify(pinyinData));
                renderVocab();
                renderGrammar();
                renderPinyin();
            } catch (error) {
                console.error('Silent sync error:', error);
            }
        }
    </script>
</body>
</html>
